<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prenotazioni â€” Casa Sopra &amp; Casa Sotto</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg:           #F5F0EB;
      --white:        #FFFFFF;
      --brown:        #1E1510;
      --muted:        #9C8C82;
      --border:       #DDD5CC;
      --weekend-bg:   rgba(0,0,0,.03);
      --sopra:        #B85C38;
      --sopra-tile:   #F5E6DF;
      --sotto:        #3A7D8A;
      --sotto-tile:   #DDF0F3;
      --airbnb:       #FF5A5F;
      --booking:      #003580;
      --esterno:      #5A7A52;
      --highlight:    #B85C38;
      --sub-row-h:    12px;
      --row-h:        24px;
      --date-col:     34px;
      --tile-fs:      9.5px;
      --tile-lh:      14px;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg);
      color: var(--brown);
      min-height: 100vh;
    }

    /* â”€â”€ HEADER â”€â”€ */
    header {
      background: var(--brown);
      padding: 16px 12px 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .header-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.1rem;
      color: #FAF7F2;
      line-height: 1.2;
    }
    .header-meta {
      font-size: .65rem;
      color: rgba(255,255,255,.35);
      margin-top: 2px;
    }
    .refresh-btn {
      background: rgba(255,255,255,.1);
      border: 1px solid rgba(255,255,255,.18);
      color: #FAF7F2;
      padding: 5px 12px;
      border-radius: 20px;
      font-family: inherit;
      font-size: .72rem;
      cursor: pointer;
      flex-shrink: 0;
    }
    .refresh-btn:active { opacity: .7; }
    .lane-header-row {
      display: grid;
      grid-template-columns: var(--date-col) 1fr 1fr;
    }
    .lane-header {
      text-align: center;
      font-size: .68rem;
      font-weight: 600;
      letter-spacing: .05em;
      padding: 5px 4px;
      border-radius: 5px 5px 0 0;
    }
    .lane-header.sopra { background: var(--sopra); color: #fff; }
    .lane-header.sotto { background: var(--sotto); color: #fff; }

    /* â”€â”€ LOADING / ERROR â”€â”€ */
    #status {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
      font-size: .85rem;
    }
    #status.error {
      color: #B71C1C;
      background: #FFF3F3;
      margin: 16px;
      border-radius: 8px;
      padding: 16px;
      text-align: left;
    }

    /* â”€â”€ CALENDAR GRID â”€â”€ */
    main { max-width: 560px; margin: 0 auto; padding-bottom: 40px; }
    #cal-grid {
      display: grid;
      grid-template-columns: var(--date-col) 1fr 1fr;
    }

    /* â”€â”€ DAY LABEL â”€â”€ */
    /* day-label and day-line each span 2 sub-rows = 1 visual day */
    .day-label {
      display: flex;
      align-items: center;
      justify-content: center;
      height: var(--row-h);  /* spans 2 sub-rows via grid-row in JS */
      border-top: 1px solid var(--border);
      background: var(--bg);
      z-index: 2;
      font-family: 'DM Mono', monospace;
      font-size: 9px;
      font-weight: 500;
      color: var(--muted);
      letter-spacing: -.01em;
    }
    .day-label.weekend { background: var(--weekend-bg); color: #b0a098; }
    .day-label.today   { color: var(--brown); font-weight: 700; }

    .month-marker {
      display: flex;
      align-items: center;
      justify-content: center;
      height: var(--row-h);
      background: var(--brown);
      color: rgba(255,255,255,.7);
      font-size: 7.5px;
      font-weight: 600;
      letter-spacing: .16em;
      text-transform: uppercase;
      z-index: 3;
    }

    /* â”€â”€ DAY LINES â”€â”€ */
    .day-line {
      height: var(--row-h);
      border-top: 1px solid var(--border);
    }
    .day-line.weekend     { background: var(--weekend-bg); }
    .day-line.month-first { border-top: 2px solid rgba(0,0,0,.1); }

    /* â”€â”€ TILE â”€â”€ */
    .tile {
      margin: 2px 3px;
      border-radius: 5px;
      padding: 5px 6px;
      z-index: 5;
      overflow: hidden;
      align-self: stretch;
      min-width: 0;
    }
    .tile.sopra-tile { background: var(--sopra-tile); border-left: 3px solid var(--sopra); }
    .tile.sotto-tile { background: var(--sotto-tile); border-left: 3px solid var(--sotto); }

    .tl {
      display: block;
      font-size: var(--tile-fs);
      line-height: var(--tile-lh);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .tl-dates {
      font-family: 'DM Mono', monospace;
      font-weight: 500;
      font-size: 9.5px;
    }
    .tl-dates .arr { color: var(--muted); }
    .tl-nights  { color: var(--muted); font-size: 8.5px; }
    .tl-source  {
      display: inline-block;
      font-size: 8px;
      font-weight: 700;
      letter-spacing: .05em;
      text-transform: uppercase;
      padding: 1px 5px;
      border-radius: 8px;
      line-height: 13px;
    }
    .src-airbnb  { background: #FFEAEA; color: var(--airbnb); }
    .src-booking { background: #E8EEF7; color: var(--booking); }
    .src-esterno { background: #EBF2EA; color: var(--esterno); }
    .tl-divider {
      display: block;
      height: 1px;
      background: rgba(0,0,0,.08);
      margin: 3px 0;
    }
    .tl-guest  { font-weight: 600; }
    .tl-detail { color: var(--muted); font-size: 8.5px; }
    .tl-money  { font-weight: 700; }
    .tl-topay  { color: var(--highlight); font-weight: 700; }
    .tl-link   { color: var(--airbnb); font-weight: 600; font-size: 8.5px; text-decoration: none; }
  </style>
</head>
<body>

<header>
  <div class="header-row">
    <div>
      <div class="header-title">Casa Sopra &amp; Casa Sotto</div>
      <div class="header-meta" id="last-updated"></div>
    </div>
    <button class="refresh-btn" onclick="loadData()">â†» Aggiorna</button>
  </div>
  <div class="lane-header-row">
    <div></div>
    <div class="lane-header sopra">Casa Sopra</div>
    <div class="lane-header sotto">Casa Sotto</div>
  </div>
</header>

<div id="status">Caricamentoâ€¦</div>
<main style="display:none"><div id="cal-grid"></div></main>

<script>
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // âš ï¸  REPLACE with your published Google Sheet CSV URL
  //     File â†’ Share â†’ Publish to web â†’ View sheet â†’ CSV â†’ Publish
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTFb8p_HMNzEV0zXhvrdSS-HsJ3SP-xOGYwyjQLO5PehyYphLhs1id276VXG12XP1cfdrp8kuVwUG5o/pub?gid=1147583746&single=true&output=csv';

  const DOW_LETTER = ['D','L','M','M','G','V','S'];
  const DOW_3      = ['Dom','Lun','Mar','Mer','Gio','Ven','Sab'];
  const MONTHS_IT  = ['GEN','FEB','MAR','APR','MAG','GIU','LUG','AGO','SET','OTT','NOV','DIC'];

  function parseDate(s) {
    if (!s) return null;
    const [y, m, d] = s.split('-').map(Number);
    if (!y || !m || !d) return null;
    return new Date(y, m - 1, d);
  }

  function daysBetween(a, b) {
    return Math.round((b - a) / 86400000);
  }

  function shortDate(dateStr) {
    const d = parseDate(dateStr);
    if (!d) return '';
    return `${DOW_3[d.getDay()]} ${d.getDate()}`;
  }

  function splitCsvLine(line) {
    const result = [];
    let cur = '', inQ = false;
    for (const ch of line) {
      if (ch === '"') { inQ = !inQ; }
      else if (ch === ',' && !inQ) { result.push(cur); cur = ''; }
      else cur += ch;
    }
    result.push(cur);
    return result;
  }

  function parseCsv(csv) {
    const lines = csv.trim().split('\n');
    if (lines.length < 2) return [];
    const headers = splitCsvLine(lines[0]).map(h => h.trim().replace(/^"|"$/g, ''));
    const rows = [];
    for (let i = 1; i < lines.length; i++) {
      const cols = splitCsvLine(lines[i]);
      const row = {};
      headers.forEach((h, idx) => { row[h] = (cols[idx] || '').trim().replace(/^"|"$/g, ''); });
      if (row['Unit'] && row['Check-in']) rows.push(row);
    }
    return rows;
  }

  async function loadData() {
    const status = document.getElementById('status');
    const main   = document.querySelector('main');
    status.textContent = 'Caricamentoâ€¦';
    status.className = '';
    status.style.display = 'block';
    main.style.display = 'none';

    try {
      const url = SHEET_CSV_URL + (SHEET_CSV_URL.includes('?') ? '&' : '?') + '_=' + Date.now();
      const res = await fetch(url);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const csv = await res.text();
      const rows = parseCsv(csv);
      buildGrid(rows);
      document.getElementById('last-updated').textContent =
        'Aggiornato ' + new Date().toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit' });
      status.style.display = 'none';
      main.style.display = 'block';
    } catch (e) {
      status.className = 'error';
      status.textContent = 'Errore nel caricamento. Controlla che il CSV sia pubblicato correttamente. (' + e.message + ')';
    }
  }

  function buildGrid(rows) {
    const grid = document.getElementById('cal-grid');
    grid.innerHTML = '';

    const today = new Date(); today.setHours(0, 0, 0, 0);
    const year  = today.getFullYear();
    const START = new Date(today);
    const END   = new Date(year, 11, 31);
    const totalDays = daysBetween(START, END) + 1;

    // 2 sub-rows per day: sub-row N*2+1 = morning, N*2+2 = afternoon
    const totalSubRows = totalDays * 2;
    grid.style.gridTemplateRows = `repeat(${totalSubRows}, 12px)`;

    // Day rows â€” each label/line spans 2 sub-rows
    for (let i = 0; i < totalDays; i++) {
      const date  = new Date(START);
      date.setDate(date.getDate() + i);
      const day   = date.getDate();
      const dow   = date.getDay();
      const isWE  = dow === 0 || dow === 6;
      const is1st = day === 1;
      const isToday = i === 0;

      const rowStart = i * 2 + 1;       // 1-based sub-row for morning
      const rowEnd   = rowStart + 2;    // spans 2 sub-rows

      if (is1st) {
        const mm = document.createElement('div');
        mm.className = 'month-marker';
        mm.style.cssText = `grid-row:${rowStart}/${rowEnd};grid-column:1`;
        mm.textContent = MONTHS_IT[date.getMonth()];
        grid.appendChild(mm);
      } else {
        const lbl = document.createElement('div');
        lbl.className = 'day-label' + (isWE ? ' weekend' : '') + (isToday ? ' today' : '');
        lbl.style.cssText = `grid-row:${rowStart}/${rowEnd};grid-column:1`;
        lbl.textContent = `${DOW_LETTER[dow]}${day}`;
        grid.appendChild(lbl);
      }

      for (const col of ['2', '3']) {
        const ln = document.createElement('div');
        ln.className = 'day-line' + (isWE ? ' weekend' : '') + (is1st ? ' month-first' : '');
        ln.style.cssText = `grid-row:${rowStart}/${rowEnd};grid-column:${col}`;
        grid.appendChild(ln);
      }
    }

    // Tiles â€” start at afternoon sub-row of check-in, end at morning sub-row of checkout
    rows.forEach(b => {
      const ciDate = parseDate(b['Check-in']);
      const coDate = parseDate(b['Check-out']);
      if (!ciDate || !coDate) return;
      if (coDate <= today) return;

      const clampedStart = ciDate < today ? today : ciDate;
      const si = daysBetween(START, clampedStart);
      const ei = daysBetween(START, coDate);
      if (si >= totalDays || ei <= 0 || si >= ei) return;

      // Tile starts at afternoon (sub-row +2) of check-in day
      // Tile ends at morning (sub-row +1) of checkout day = no overlap with checkout morning
      const tileRowStart = si * 2 + 2;    // afternoon of check-in
      const tileRowEnd   = ei * 2 + 2;    // afternoon of checkout

      if (tileRowEnd <= tileRowStart) return;

      const nights    = daysBetween(ciDate, coDate);
      const unit      = b['Unit'];
      const source    = b['Source'];
      const col       = unit === 'Casa Sopra' ? '2' : '3';
      const tileClass = unit === 'Casa Sopra' ? 'sopra-tile' : 'sotto-tile';
      const srcClass  = { Airbnb: 'src-airbnb', Booking: 'src-booking', Esterno: 'src-esterno' }[source] || 'src-booking';

      let html = '';
      html += `<span class="tl tl-dates">${shortDate(b['Check-in'])}<span class="arr"> â†’ </span>${shortDate(b['Check-out'])}</span>`;
      html += `<span class="tl tl-nights">${nights} notti</span>`;
      html += `<span class="tl"><span class="tl-source ${srcClass}">${source}</span></span>`;

      if (source === 'Esterno') {
        const guest   = b['Guest Name']    || '';
        const people  = b['N. Guests']     || '';
        const pets    = b['Pets']          || '';
        const contact = b['Contact']       || '';
        const total   = b['Total Price']   || '';
        const topay   = b['Amount to Pay'] || '';
        const notes   = b['Notes']         || '';

        if (guest || people || contact || total || topay || notes) {
          html += `<span class="tl-divider"></span>`;
          if (guest)   html += `<span class="tl tl-guest">${guest}</span>`;
          if (people)  html += `<span class="tl tl-detail">${people} persone${pets === 'yes' ? ' Â· ğŸ¾' : ''}</span>`;
          if (contact) html += `<span class="tl tl-detail">${contact}</span>`;
          if (total)   html += `<span class="tl tl-money">${total}</span>`;
          if (topay)   html += `<span class="tl tl-topay">Saldo ${topay}</span>`;
          if (notes)   html += `<span class="tl tl-detail">${notes}</span>`;
        }
      }

      if (source === 'Airbnb' && b['Airbnb URL']) {
        html += `<a class="tl tl-link" href="${b['Airbnb URL']}" target="_blank">Apri Airbnb â†—</a>`;
      }

      const tile = document.createElement('div');
      tile.className = `tile ${tileClass}`;
      tile.style.cssText = `grid-row:${tileRowStart}/${tileRowEnd};grid-column:${col}`;
      tile.innerHTML = html;
      grid.appendChild(tile);
    });
  }

  loadData();
</script>
</body>
</html>
