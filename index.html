<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Prenotazioni â€” Casa Sopra & Casa Sotto</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Source+Sans+3:wght@300;400;600&display=swap" rel="stylesheet" />
  <style>
    /* â”€â”€ Variables â”€â”€ */
    :root {
      --cream:      #FAF7F2;
      --white:      #FFFFFF;
      --brown:      #2A1F1A;
      --brown-mid:  #5C4033;
      --brown-light:#9C8075;
      --sopra:      #B85C38;   /* terracotta */
      --sotto:      #3E7D8A;   /* dusty teal */
      --airbnb:     #FF5A5F;
      --booking:    #003580;
      --esterno:    #5A7A52;
      --border:     #EDE8E0;
      --shadow:     0 2px 12px rgba(42,31,26,.08);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Source Sans 3', sans-serif;
      background: var(--cream);
      color: var(--brown);
      min-height: 100vh;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      background: var(--brown);
      color: var(--cream);
      padding: 24px 20px 20px;
      text-align: center;
    }
    header h1 {
      font-family: 'Playfair Display', serif;
      font-size: 1.6rem;
      letter-spacing: .03em;
      margin-bottom: 4px;
    }
    header p {
      font-size: .8rem;
      color: var(--brown-light);
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    #last-updated {
      font-size: .75rem;
      color: #9C8075;
      margin-top: 6px;
    }

    /* â”€â”€ Layout â”€â”€ */
    main {
      max-width: 900px;
      margin: 0 auto;
      padding: 24px 16px 48px;
    }

    .units-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 32px;
    }
    @media (min-width: 640px) {
      .units-grid { grid-template-columns: 1fr 1fr; }
    }

    /* â”€â”€ Unit section â”€â”€ */
    .unit-section {}

    .unit-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
    }
    .unit-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      flex-shrink: 0;
    }
    .sopra .unit-dot  { background: var(--sopra); }
    .sotto .unit-dot  { background: var(--sotto); }

    .unit-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.15rem;
      font-weight: 700;
    }
    .unit-count {
      margin-left: auto;
      font-size: .72rem;
      color: var(--brown-light);
      text-transform: uppercase;
      letter-spacing: .07em;
    }

    /* â”€â”€ Booking card â”€â”€ */
    .booking-card {
      background: var(--white);
      border-radius: 10px;
      padding: 14px 16px;
      margin-bottom: 10px;
      box-shadow: var(--shadow);
      border-left: 4px solid transparent;
      transition: transform .15s ease;
    }
    .booking-card:active { transform: scale(.98); }

    .sopra .booking-card { border-left-color: var(--sopra); }
    .sotto .booking-card { border-left-color: var(--sotto); }

    .card-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 8px;
    }

    .dates {
      font-size: .95rem;
      font-weight: 600;
      line-height: 1.3;
    }
    .dates .sep {
      color: var(--brown-light);
      font-weight: 300;
      margin: 0 4px;
    }
    .nights {
      font-size: .72rem;
      color: var(--brown-light);
      margin-top: 2px;
    }

    .source-badge {
      font-size: .68rem;
      font-weight: 600;
      letter-spacing: .07em;
      text-transform: uppercase;
      padding: 3px 8px;
      border-radius: 20px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .badge-airbnb   { background: #FFEAEA; color: var(--airbnb); }
    .badge-booking  { background: #E8EEF7; color: var(--booking); }
    .badge-esterno  { background: #EBF2EA; color: var(--esterno); }

    /* â”€â”€ Details section â”€â”€ */
    .card-details {
      border-top: 1px solid var(--border);
      padding-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .detail-row {
      display: flex;
      align-items: baseline;
      gap: 6px;
      font-size: .82rem;
    }
    .detail-label {
      color: var(--brown-light);
      font-size: .72rem;
      text-transform: uppercase;
      letter-spacing: .06em;
      min-width: 70px;
      flex-shrink: 0;
    }
    .detail-value {
      color: var(--brown);
      font-weight: 400;
    }
    .detail-value a {
      color: var(--airbnb);
      text-decoration: none;
      font-weight: 600;
      font-size: .78rem;
    }
    .detail-value a:hover { text-decoration: underline; }

    .price-row .detail-value {
      font-weight: 600;
      font-size: .9rem;
    }
    .price-to-pay {
      color: var(--sopra);
    }

    /* â”€â”€ Empty / loading states â”€â”€ */
    .empty {
      text-align: center;
      padding: 32px 16px;
      color: var(--brown-light);
      font-size: .85rem;
    }

    #loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--brown-light);
      font-size: .9rem;
    }

    #error-msg {
      background: #FFF3F3;
      border: 1px solid #FFCDD2;
      color: #B71C1C;
      padding: 16px;
      border-radius: 8px;
      margin: 20px 0;
      font-size: .85rem;
      display: none;
    }

    /* â”€â”€ Pulizie section â”€â”€ */
    .pulizie-section {
      margin-bottom: 32px;
    }
    .pulizie-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
    }
    .pulizie-icon {
      font-size: 1.1rem;
    }
    .pulizie-title {
      font-family: 'Playfair Display', serif;
      font-size: 1.15rem;
      font-weight: 700;
    }
    .pulizie-card {
      background: var(--white);
      border-radius: 10px;
      padding: 14px 16px;
      margin-bottom: 10px;
      box-shadow: var(--shadow);
      border-left: 4px solid transparent;
    }
    .pulizie-card.urgency-red    { border-left-color: #D32F2F; }
    .pulizie-card.urgency-amber  { border-left-color: #F57C00; }
    .pulizie-card.urgency-green  { border-left-color: #388E3C; }
    .pulizie-card.urgency-none   { border-left-color: var(--border); }

    .pulizie-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
      margin-bottom: 8px;
    }
    .pulizie-date {
      font-size: .95rem;
      font-weight: 600;
    }
    .pulizie-unit-label {
      font-size: .72rem;
      color: var(--brown-light);
      margin-top: 2px;
    }
    .pulizie-days-badge {
      font-size: .72rem;
      font-weight: 700;
      letter-spacing: .05em;
      text-transform: uppercase;
      padding: 3px 10px;
      border-radius: 20px;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .badge-red   { background: #FFEBEE; color: #D32F2F; }
    .badge-amber { background: #FFF3E0; color: #E65100; }
    .badge-green { background: #E8F5E9; color: #2E7D32; }
    .badge-grey  { background: #F5F5F5; color: #757575; }

    .pulizie-details {
      border-top: 1px solid var(--border);
      padding-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .pulizie-row {
      font-size: .82rem;
      display: flex;
      align-items: baseline;
      gap: 6px;
    }
    .pulizie-row-label {
      color: var(--brown-light);
      font-size: .72rem;
      text-transform: uppercase;
      letter-spacing: .06em;
      min-width: 80px;
      flex-shrink: 0;
    }
    .pulizie-warning {
      margin-top: 6px;
      font-size: .8rem;
      font-weight: 600;
      color: #D32F2F;
    }

    /* â”€â”€ Refresh button â”€â”€ */
    .refresh-bar {
      text-align: center;
      margin-bottom: 20px;
    }
    .refresh-btn {
      background: none;
      border: 1px solid var(--border);
      color: var(--brown-mid);
      padding: 7px 18px;
      border-radius: 20px;
      font-family: inherit;
      font-size: .78rem;
      cursor: pointer;
      letter-spacing: .05em;
      transition: background .15s;
    }
    .refresh-btn:hover { background: var(--border); }
  </style>
</head>
<body>

<header>
  <h1>Casa Sopra &amp; Casa Sotto</h1>
  <p>Prenotazioni in corso</p>
  <div id="last-updated"></div>
</header>

<main>
  <div id="error-msg"></div>
  <div id="loading">Caricamento prenotazioniâ€¦</div>

  <div id="content" style="display:none">
    <div class="refresh-bar">
      <button class="refresh-btn" onclick="loadData()">â†» Aggiorna</button>
    </div>
    <div class="pulizie-section">
      <div class="pulizie-header">
        <span class="pulizie-icon">ğŸ§¹</span>
        <span class="pulizie-title">Pulizie</span>
      </div>
      <div id="pulizie-list"></div>
    </div>

    <div class="units-grid">
      <div class="unit-section sopra" id="section-sopra">
        <div class="unit-header">
          <span class="unit-dot"></span>
          <span class="unit-title">Casa Sopra</span>
          <span class="unit-count" id="count-sopra"></span>
        </div>
        <div id="bookings-sopra"></div>
      </div>
      <div class="unit-section sotto" id="section-sotto">
        <div class="unit-header">
          <span class="unit-dot"></span>
          <span class="unit-title">Casa Sotto</span>
          <span class="unit-count" id="count-sotto"></span>
        </div>
        <div id="bookings-sotto"></div>
      </div>
    </div>
  </div>
</main>

<script>
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // âš ï¸  REPLACE THIS URL with your published Google Sheet CSV URL
  //
  // In Google Sheets:
  //   File â†’ Share â†’ Publish to web
  //   Select the "View" sheet â†’ CSV â†’ Publish
  //   Copy the URL and paste it below
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const SHEET_CSV_URL = 'YOUR_PUBLISHED_CSV_URL_HERE';

  async function loadData() {
    document.getElementById('loading').style.display = 'block';
    document.getElementById('content').style.display = 'none';
    document.getElementById('error-msg').style.display = 'none';

    try {
      // Add cache-busting param
      const url = SHEET_CSV_URL + (SHEET_CSV_URL.includes('?') ? '&' : '?') + '_=' + Date.now();
      const res = await fetch(url);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const csv = await res.text();
      const bookings = parseCsv(csv);
      render(bookings);
      document.getElementById('last-updated').textContent =
        'Aggiornato: ' + new Date().toLocaleTimeString('it-IT', {hour:'2-digit', minute:'2-digit'});
    } catch (e) {
      const el = document.getElementById('error-msg');
      el.style.display = 'block';
      el.textContent = 'Errore nel caricamento dati. Controlla che il CSV sia pubblicato correttamente. (' + e.message + ')';
    } finally {
      document.getElementById('loading').style.display = 'none';
    }
  }

  function parseCsv(csv) {
    const lines = csv.trim().split('\n');
    if (lines.length < 2) return [];
    const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
    const bookings = [];
    for (let i = 1; i < lines.length; i++) {
      const cols = splitCsvLine(lines[i]);
      const row = {};
      headers.forEach((h, idx) => { row[h] = (cols[idx] || '').trim().replace(/^"|"$/g, ''); });
      if (!row['Unit'] || !row['Check-in']) continue;
      bookings.push(row);
    }
    return bookings;
  }

  // Handles quoted fields with commas
  function splitCsvLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        inQuotes = !inQuotes;
      } else if (ch === ',' && !inQuotes) {
        result.push(current);
        current = '';
      } else {
        current += ch;
      }
    }
    result.push(current);
    return result;
  }

  function formatDisplayDate(dateStr) {
    if (!dateStr) return 'â€”';
    const [y, m, d] = dateStr.split('-');
    if (!y || !m || !d) return dateStr;
    const months = ['gen','feb','mar','apr','mag','giu','lug','ago','set','ott','nov','dic'];
    return `${parseInt(d)} ${months[parseInt(m)-1]}`;
  }

  function render(bookings) {
    const sopra = bookings.filter(b => b['Unit'] === 'Casa Sopra');
    const sotto = bookings.filter(b => b['Unit'] === 'Casa Sotto');

    document.getElementById('count-sopra').textContent =
      sopra.length + ' prenotazion' + (sopra.length === 1 ? 'e' : 'i');
    document.getElementById('count-sotto').textContent =
      sotto.length + ' prenotazion' + (sotto.length === 1 ? 'e' : 'i');

    renderUnit('bookings-sopra', sopra);
    renderUnit('bookings-sotto', sotto);
    renderPulizie(bookings);

    document.getElementById('content').style.display = 'block';
  }

  function dateFromStr(s) {
    if (!s) return null;
    const [y, m, d] = s.split('-').map(Number);
    return new Date(y, m - 1, d);
  }

  function addDays(date, n) {
    const d = new Date(date);
    d.setDate(d.getDate() + n);
    return d;
  }

  function sameDay(a, b) {
    return a.getFullYear() === b.getFullYear() &&
           a.getMonth()    === b.getMonth()    &&
           a.getDate()     === b.getDate();
  }

  function daysBetween(a, b) {
    return Math.round((b - a) / (1000 * 60 * 60 * 24));
  }

  function renderPulizie(bookings) {
    const container = document.getElementById('pulizie-list');
    container.innerHTML = '';

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Build list of checkouts from today onwards
    const checkouts = bookings
      .map(b => ({ unit: b['Unit'], checkout: b['Check-out'], checkin: b['Check-in'] }))
      .filter(b => {
        const d = dateFromStr(b.checkout);
        return d && d >= today;
      })
      .sort((a, b) => a.checkout.localeCompare(b.checkout));

    if (checkouts.length === 0) {
      container.innerHTML = '<div class="empty">Nessun checkout in programma</div>';
      return;
    }

    // For each checkout, find next checkin in same unit and status of other unit
    const otherUnit = u => u === 'Casa Sopra' ? 'Casa Sotto' : 'Casa Sopra';

    const cards = [];

    for (const co of checkouts) {
      const coDate = dateFromStr(co.checkout);
      const thisUnit = co.unit;
      const other = otherUnit(thisUnit);

      // Find next checkin in same unit after this checkout
      const sameUnitCheckins = bookings
        .filter(b => b['Unit'] === thisUnit)
        .map(b => dateFromStr(b['Check-in']))
        .filter(d => d && d >= coDate)
        .sort((a, b) => a - b);

      const nextCheckin = sameUnitCheckins[0] || null;
      const daysToClean = nextCheckin ? daysBetween(coDate, nextCheckin) : null;

      // Other unit status on checkout day
      let otherStatus = '';
      const otherBookings = bookings.filter(b => b['Unit'] === other);

      const otherCheckout = otherBookings.find(b => sameDay(dateFromStr(b['Check-out']), coDate));
      const otherCheckin  = otherBookings.find(b => sameDay(dateFromStr(b['Check-in']),  coDate));
      const otherOccupied = otherBookings.find(b => {
        const ci = dateFromStr(b['Check-in']);
        const cx = dateFromStr(b['Check-out']);
        return ci && cx && coDate > ci && coDate < cx;
      });

      let otherStatusText = '';
      let parallelWarning = false;

      if (otherCheckout) {
        otherStatusText = `${other}: anche in pulizia`;
        parallelWarning = true;
      } else if (otherCheckin) {
        otherStatusText = `${other}: arrivo ospiti`;
      } else if (otherOccupied) {
        otherStatusText = `${other}: occupata`;
      } else {
        otherStatusText = `${other}: libera`;
      }

      // Urgency
      let urgencyClass = 'urgency-none';
      let badgeClass   = 'badge-grey';
      let badgeLabel   = 'Nessun arrivo';

      if (daysToClean !== null) {
        if (daysToClean <= 1) {
          urgencyClass = 'urgency-red';
          badgeClass   = 'badge-red';
          badgeLabel   = daysToClean === 0 ? 'Stesso giorno' : '1 giorno';
        } else if (daysToClean === 2) {
          urgencyClass = 'urgency-amber';
          badgeClass   = 'badge-amber';
          badgeLabel   = '2 giorni';
        } else {
          urgencyClass = 'urgency-green';
          badgeClass   = 'badge-green';
          badgeLabel   = daysToClean + ' giorni';
        }
      }

      cards.push({
        coDate,
        co,
        daysToClean,
        nextCheckin,
        otherStatusText,
        parallelWarning,
        urgencyClass,
        badgeClass,
        badgeLabel
      });
    }

    for (const c of cards) {
      const nextCheckinStr = c.nextCheckin
        ? `checkin ${formatDisplayDate(c.nextCheckin.getFullYear() + '-' + String(c.nextCheckin.getMonth()+1).padStart(2,'0') + '-' + String(c.nextCheckin.getDate()).padStart(2,'0'))}`
        : 'nessun arrivo previsto';

      const card = document.createElement('div');
      card.className = `pulizie-card ${c.urgencyClass}`;
      card.innerHTML = `
        <div class="pulizie-top">
          <div>
            <div class="pulizie-date">${formatDisplayDate(c.co.checkout)} â€” ${c.co.unit}</div>
            <div class="pulizie-unit-label">Checkout</div>
          </div>
          <span class="pulizie-days-badge ${c.badgeClass}">${c.badgeLabel}</span>
        </div>
        <div class="pulizie-details">
          <div class="pulizie-row">
            <span class="pulizie-row-label">Finestra</span>
            <span>${c.daysToClean !== null ? c.daysToClean + (c.daysToClean === 1 ? ' giorno' : ' giorni') + ' per pulire (' + nextCheckinStr + ')' : 'Nessun arrivo previsto'}</span>
          </div>
          <div class="pulizie-row">
            <span class="pulizie-row-label">Altra unitÃ </span>
            <span>${c.otherStatusText}</span>
          </div>
          ${c.parallelWarning ? `<div class="pulizie-warning">âš ï¸ Servono 2 persone in parallelo</div>` : ''}
        </div>
      `;
      container.appendChild(card);
    }
  }

  function renderUnit(containerId, bookings) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';

    if (bookings.length === 0) {
      container.innerHTML = '<div class="empty">Nessuna prenotazione</div>';
      return;
    }

    for (const b of bookings) {
      const source   = b['Source'] || '';
      const checkin  = b['Check-in'] || '';
      const checkout = b['Check-out'] || '';
      const nights   = b['Nights'] || '';
      const url      = b['Airbnb URL'] || '';
      const guestName   = b['Guest Name'] || '';
      const numGuests   = b['N. Guests'] || '';
      const pets        = b['Pets'] || '';
      const contact     = b['Contact'] || '';
      const totalPrice  = b['Total Price'] || '';
      const amountToPay = b['Amount to Pay'] || '';
      const notes       = b['Notes'] || '';

      let badgeClass = 'badge-booking';
      let badgeLabel = 'Booking';
      if (source === 'Airbnb')   { badgeClass = 'badge-airbnb';  badgeLabel = 'Airbnb'; }
      if (source === 'Esterno')  { badgeClass = 'badge-esterno'; badgeLabel = 'Esterno'; }

      let detailsHtml = '';

      // Airbnb: show reservation URL
      if (source === 'Airbnb' && url) {
        detailsHtml += detailRow('Link', `<a href="${url}" target="_blank">Apri su Airbnb â†—</a>`);
      }

      // Esterno: show guest details
      if (source === 'Esterno') {
        if (guestName)   detailsHtml += detailRow('Ospite', guestName);
        if (numGuests)   detailsHtml += detailRow('Persone', numGuests);
        if (pets)        detailsHtml += detailRow('Animali', pets === 'yes' ? 'ğŸ¾ SÃ¬' : 'No');
        if (contact)     detailsHtml += detailRow('Contatto', contact);
        if (totalPrice)  detailsHtml += detailRow('Totale', totalPrice, 'price-row');
        if (amountToPay) detailsHtml += detailRow('Da incassare', `<span class="price-to-pay">${amountToPay}</span>`, 'price-row');
        if (notes)       detailsHtml += detailRow('Note', notes);
      }

      const card = document.createElement('div');
      card.className = 'booking-card';
      card.innerHTML = `
        <div class="card-top">
          <div>
            <div class="dates">
              ${formatDisplayDate(checkin)}
              <span class="sep">â†’</span>
              ${formatDisplayDate(checkout)}
            </div>
            <div class="nights">${nights ? nights + ' notti' : ''}</div>
          </div>
          <span class="source-badge ${badgeClass}">${badgeLabel}</span>
        </div>
        ${detailsHtml ? `<div class="card-details">${detailsHtml}</div>` : ''}
      `;
      container.appendChild(card);
    }
  }

  function detailRow(label, value, extraClass = '') {
    return `
      <div class="detail-row ${extraClass}">
        <span class="detail-label">${label}</span>
        <span class="detail-value">${value}</span>
      </div>`;
  }

  // Auto-load on page open
  loadData();
</script>

</body>
</html>
